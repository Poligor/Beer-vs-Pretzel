<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tic‑Tac‑Toe • Beer vs Pretzel</title>
  <meta name="description" content="A tiny, shareable Tic‑Tac‑Toe for LinkedIn posts. X=🍺 Beer, O=🥨 Pretzel. Copy the board as text or share a link to the current state." />
  <style>
    :root{
      --bg:#0f1115;--panel:#171922;--muted:#9aa3b2;--text:#e6e8ef;--accent:#7bd88f;--beer:#ffd166;--pretzel:#ff8fab;--grid:#2a2f3a;--shadow:0 10px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -10%,#1f2230 0%,transparent 50%),radial-gradient(1200px 800px at 110% 10%,#23283a 0%,transparent 52%),var(--bg);color:var(--text);font:16px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin:8px 0 18px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:42px;height:42px;display:grid;place-items:center;border-radius:12px;background:linear-gradient(135deg,#202637,#0d0f15);box-shadow:var(--shadow);font-size:24px}
    h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.2px}
    .panel{background:linear-gradient(190deg,#141824,#0f121a);border:1px solid #232739;border-radius:18px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:repeat(3, minmax(90px,1fr));gap:10px;padding:18px}
    .cell{aspect-ratio:1 / 1;display:grid;place-items:center;border-radius:16px;background:linear-gradient(180deg,#1a1f2b,#121620);border:1px solid var(--grid);cursor:pointer;font-size:56px;transition:transform .06s ease, box-shadow .1s ease}
    .cell:active{transform:scale(.98)}
    .cell[disabled]{cursor:not-allowed;opacity:.5}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;padding:14px;border-top:1px solid #202436}
    button, .btn{appearance:none;border:none;background:#1d2331;border:1px solid #2a3146;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;letter-spacing:.2px;transition:transform .06s ease,opacity .2s ease}
    button:hover{opacity:.9}
    .primary{background:linear-gradient(180deg,#2a334a,#1a2131);border-color:#3a4666}
    .beer{background:linear-gradient(180deg,#40351a,#2a2310);border-color:#5a4720}
    .pretzel{background:linear-gradient(180deg,#402028,#271219);border-color:#5a2a38}
    .accent{background:linear-gradient(180deg,#1e3a2b,#14251d);border-color:#284e3b}
    .status{display:flex;align-items:center;gap:10px;padding:14px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #2a3146;background:#171c29;font-size:14px}
    .legend{display:flex;gap:8px;flex-wrap:wrap}
    .legend .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#151a26;border:1px solid #242b3f}
    .tag.beer{border-color:#5a4720}
    .tag.pretzel{border-color:#5a2a38}
    .footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1}
    .sr{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
    #testBadge{position:fixed;right:12px;bottom:12px;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #2a3146;background:#141824;color:var(--muted);box-shadow:var(--shadow);opacity:.9}
    @media (max-width:600px){
      .grid{gap:8px}
      .cell{font-size:48px;border-radius:14px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden>🎮</div>
        <div>
          <h1>Beer vs Pretzel — Tic‑Tac‑Toe</h1>
          <div class="legend" aria-label="Legend">
            <span class="tag beer">X = 🍺 Beer</span>
            <span class="tag pretzel">O = 🥨 Pretzel</span>
          </div>
        </div>
      </div>
      <div class="flex">
        <button id="newGame" class="primary">New game</button>
        <button id="toggleAI" class="accent">Play vs Computer: OFF</button>
      </div>
    </header>

    <section id="board" class="panel" aria-label="Game board">
      <div class="status">
        <span class="badge" id="turnBadge">Turn: <strong style="margin-left:6px">🍺</strong></span>
        <span class="badge" id="stateBadge">State: <strong style="margin-left:6px">Playing</strong></span>
        <span class="grow"></span>
        <div class="flex">
          <button id="copyText" title="Copy board as text for LinkedIn comments">Copy board as text</button>
          <button id="copyLink" class="accent" title="Copy shareable link to this exact board">Copy shareable link</button>
        </div>
      </div>
      <div class="grid" role="grid" aria-label="3 by 3 tic‑tac‑toe grid">
        <!-- cells injected by JS -->
      </div>
      <div class="toolbar">
        <div class="flex">
          <span class="badge">Starter:</span>
          <button data-starter="X" class="beer">🍺 starts</button>
          <button data-starter="O" class="pretzel">🥨 starts</button>
        </div>
        <div class="flex">
          <button id="undo">Undo</button>
          <button id="reset">Reset</button>
        </div>
      </div>
    </section>

    <p class="footer">Tip: After each move, click <em>Copy board as text</em> and paste it to your LinkedIn comments to "play inside the post". Use <em>Copy shareable link</em> to let people open the same state in their browser.</p>
  </div>

  <div id="testBadge" aria-live="polite" title="Self‑tests run on load">Tests: pending…</div>

  <script>
    // ─────────────────────────────────────────────────────────────────────────────
    // Core constants & helpers
    // ─────────────────────────────────────────────────────────────────────────────
    const X = 'X';
    const O = 'O';
    const EMOJI = { X: '🍺', O: '🥨', E: '⬜' };
    const qs = new URLSearchParams(location.search);

    // Game state (renamed to avoid shadowing window.history)
    let board = Array(9).fill(null);
    let turn = X;
    let moveStack = []; // previously named `history` — renamed to prevent collisions

    // AI toggles
    let aiEnabled = false;
    let humanPlayer = X; // who the human is currently playing as

    // DOM refs
    const grid = document.querySelector('.grid');
    const turnBadge = document.getElementById('turnBadge');
    const stateBadge = document.getElementById('stateBadge');
    const copyTextBtn = document.getElementById('copyText');
    const copyLinkBtn = document.getElementById('copyLink');
    const toggleAI = document.getElementById('toggleAI');
    const testBadge = document.getElementById('testBadge');

    // Build cells
    const cells = [];
    for (let i=0;i<9;i++){
      const btn = document.createElement('button');
      btn.className = 'cell';
      btn.setAttribute('role','gridcell');
      btn.setAttribute('aria-label','Empty cell');
      btn.addEventListener('click', ()=>handleMove(i));
      grid.appendChild(btn);
      cells.push(btn);
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // Controls
    // ─────────────────────────────────────────────────────────────────────────────
    document.getElementById('newGame').addEventListener('click', ()=>{reset(); randomStarter(); maybeAIMove();});
    document.getElementById('reset').addEventListener('click', ()=>{reset(); maybeAIMove();});
    document.getElementById('undo').addEventListener('click', ()=>{undo(); maybeAIMove();});

    document.querySelectorAll('[data-starter]').forEach(b=>b.addEventListener('click', e=>{
      const starter = e.currentTarget.getAttribute('data-starter');
      reset();
      turn = starter;
      humanPlayer = starter;
      render();
      pushURL();
      maybeAIMove();
    }));

    toggleAI.addEventListener('click', ()=>{
      aiEnabled = !aiEnabled;
      toggleAI.textContent = `Play vs Computer: ${aiEnabled? 'ON':'OFF'}`;
      reset();
      if (aiEnabled && turn !== humanPlayer) maybeAIMove();
    });

    copyTextBtn.addEventListener('click', async ()=>{
      const text = boardToText(board);
      try{ await navigator.clipboard.writeText(text); toast('Board copied! Paste into LinkedIn comments.'); }
      catch(err){ fallbackCopy(text); }
    });

    copyLinkBtn.addEventListener('click', async ()=>{
      const url = shareURL();
      try{ await navigator.clipboard.writeText(url); toast('Shareable link copied!'); }
      catch(err){ fallbackCopy(url); }
    });

    function fallbackCopy(text){
      const t = document.createElement('textarea');
      t.value = text; document.body.appendChild(t); t.select();
      try{document.execCommand('copy'); toast('Copied!');}catch(e){}
      t.remove();
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // Game logic
    // ─────────────────────────────────────────────────────────────────────────────
    function handleMove(i){
      if (board[i] || winner(board) || isDraw(board)) return;
      moveStack.push(board.slice());
      board[i] = turn;
      turn = turn===X ? O : X;
      render();
      pushURL();
      maybeAIMove();
    }

    function maybeAIMove(){
      if (!aiEnabled) return;
      if (winner(board) || isDraw(board)) return;
      if (turn === humanPlayer) return;
      setTimeout(computerMove, 250);
    }

    function computerMove(){
      // simple AI: win > block > random
      let move = findBestMove(board, turn);
      if (move == null){
        const empty = board.map((v,i)=> v?null:i).filter(v=>v!==null);
        if (!empty.length) return;
        move = empty[Math.floor(Math.random()*empty.length)];
      }
      moveStack.push(board.slice());
      board[move] = turn;
      turn = turn===X?O:X;
      render();
      pushURL();
    }

    function findBestMove(b,player){
      // Try win
      for(let i=0;i<9;i++) if(!b[i]){ b[i]=player; if(winner(b)===player){ b[i]=null; return i; } b[i]=null; }
      // Try block
      const opp = player===X?O:X;
      for(let i=0;i<9;i++) if(!b[i]){ b[i]=opp; if(winner(b)===opp){ b[i]=null; return i; } b[i]=null; }
      return null;
    }

    function undo(){
      if (!moveStack.length) return;
      board = moveStack.pop();
      const count = board.filter(Boolean).length;
      turn = (count % 2 === 0) ? X : O;
      render();
      pushURL();
    }

    function reset(){
      board = Array(9).fill(null);
      moveStack = [];
      turn = X;
      humanPlayer = X;
      render();
      pushURL();
    }

    function randomStarter(){
      turn = Math.random()<.5?X:O;
      humanPlayer = turn;
      render();
      pushURL();
    }

    function winner(b){
      const lines = [ [0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6] ];
      for (const [a,c,d] of lines){ if (b[a] && b[a]===b[c] && b[a]===b[d]) return b[a]; }
      return null;
    }

    function isDraw(b){ return !winner(b) && b.every(x=>x); }

    function render(){
      const w = winner(board);
      const draw = isDraw(board);
      for (let i=0;i<9;i++){
        const v = board[i];
        cells[i].textContent = v ? EMOJI[v] : '';
        cells[i].setAttribute('aria-label', v? (v===X?'Beer':'Pretzel') : 'Empty cell');
        // Disable if game over OR AI's turn (prevents double input)
        cells[i].disabled = Boolean(w || draw || (aiEnabled && turn !== humanPlayer));
      }
      turnBadge.innerHTML = 'Turn: <strong style="margin-left:6px">' + (turn===X?EMOJI.X:EMOJI.O) + '</strong>';
      if (w){ stateBadge.innerHTML = 'State: <strong style="margin-left:6px">' + (w===X? '🍺 wins!':'🥨 wins!') + '</strong>'; }
      else if (draw){ stateBadge.innerHTML = 'State: <strong style="margin-left:6px">Draw</strong>'; }
      else { stateBadge.innerHTML = 'State: <strong style="margin-left:6px">Playing' + (aiEnabled? ' · vs 🤖':'' ) + '</strong>'; }
    }

    function boardToText(b){
      const em = i=> b[i] ? EMOJI[b[i]] : EMOJI.E;
      const rows = [0,3,6].map(i=> `${em(i)} | ${em(i+1)} | ${em(i+2)}`);
      const header = 'Beer vs Pretzel – Tic‑Tac‑Toe';
      const hint = '\nYour move: reply with row (1‑3) & col (1‑3).';
      const mode = aiEnabled ? `\nMode: You vs Computer (${humanPlayer===X?'You: 🍺':'You: 🥨'})` : '';
      return header + '\n' + rows.join('\n') + hint + mode;
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // URL state handling (no reliance on history.replaceState)
    // ─────────────────────────────────────────────────────────────────────────────
    function encodeState(){ return board.map(c=> c?c:'_').join('') + ':' + turn; }

    function decodeState(s){
      const [grid, t] = s.split(':');
      if (!grid || grid.length!==9) return false;
      const arr = grid.split('').map(ch=> ch==='_'?null:(ch==='X'?X:O));
      if (t!==X && t!==O) return false;
      board = arr; turn = t; return true;
    }

    function shareURL(){ const url = new URL(location.href); url.searchParams.set('s', encodeState()); return url.toString(); }

    // Fallback-friendly URL updater
    function safeReplaceURL(urlString, hist){
      try{
        const h = hist || (typeof window!=='undefined' ? window.history : null);
        if (h && typeof h.replaceState === 'function'){
          h.replaceState(null, '', urlString);
          return 'history';
        }
      }catch(e){/* ignore */}
      // Fallback: store state in the hash so sharing still kind of works
      try{
        const u = new URL(urlString);
        const s = u.searchParams.get('s');
        if (typeof location !== 'undefined'){
          location.hash = 's=' + s;
          return 'hash';
        }
      }catch(e){/* ignore */}
      return 'noop';
    }

    function pushURL(){
      try{
        const url = new URL(location.href);
        url.searchParams.set('s', encodeState());
        safeReplaceURL(url.toString());
      }catch(e){ /* no-op in very restricted environments */ }
    }

    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.position='fixed'; t.style.bottom='18px'; t.style.left='50%';
      t.style.transform='translateX(-50%)'; t.style.background='#141824';
      t.style.border='1px solid #2a3146'; t.style.padding='10px 14px';
      t.style.borderRadius='12px'; t.style.boxShadow='var(--shadow)';
      t.style.zIndex='9999';
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),1400);
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // Boot
    // ─────────────────────────────────────────────────────────────────────────────
    const seed = qs.get('s');
    if (seed && decodeState(seed)){ render(); }
    else { reset(); }

    // ─────────────────────────────────────────────────────────────────────────────
    // Minimal test harness (adds tests since none existed previously)
    // Run automatically; shows status in bottom-right badge & logs details to console
    // ─────────────────────────────────────────────────────────────────────────────
    window.__T3__ = { winner, isDraw, encodeState, decodeState, safeReplaceURL };
    (function runTests(){
      const cases = [];
      function test(name, fn){
        try{ const ok = fn(); cases.push({name, ok}); return ok; }
        catch(e){ cases.push({name, ok:false, e}); return false; }
      }

      // Winner detection
      test('winner: row', ()=> winner([X,X,X,null,null,null,null,null,null])===X);
      test('winner: col', ()=> winner([O,null,X, O,null,X, O,null,null])===O);
      test('winner: diag',()=> winner([X,null,O, null,X,O, null,null,X])===X);

      // Draw detection
      test('draw: full no winner', ()=> isDraw([X,O,X, X,O,O, O,X,O])===true);

      // Encode/decode roundtrip
      test('encode/decode roundtrip', ()=>{
        const saveBoard = board.slice(); const saveTurn = turn;
        board = [X,O,null, null,X,null, null,null,O]; turn = O;
        const s = encodeState();
        board = Array(9).fill(null); turn = X;
        const ok = decodeState(s) && (board.join(',') === [X,O,null,null,X,null,null,null,O].join(',')) && turn===O;
        board = saveBoard; turn = saveTurn; return ok;
      });

      // URL replace fallback paths (do not rely on real window.history)
      test('safeReplaceURL: uses history when available', ()=>{
        let called = false; const stub = { replaceState: ()=>{called=true;} };
        const res = safeReplaceURL('https://example.com/?s=_________:X', stub);
        return res==='history' && called===true;
      });
      test('safeReplaceURL: falls back when replaceState missing', ()=>{
        const res = safeReplaceURL('https://example.com/?s=_________:X', {});
        return res==='hash' || res==='noop';
      });

      const passed = cases.filter(c=>c.ok).length;
      const total = cases.length;
      testBadge.textContent = `Tests: ${passed}/${total} passed`;
      testBadge.style.color = passed===total ? '#7bd88f' : '#ff8fab';
      // Log details
      console.group('Tic‑Tac‑Toe self‑tests');
      for (const c of cases){ console[c.ok?'log':'error'](`%c${c.ok?'✓':'✗'} ${c.name}`, c.ok?'color:#7bd88f':'color:#ff8fab', c.e||''); }
      console.groupEnd();
    })();
  </script>
</body>
</html>
